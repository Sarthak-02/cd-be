generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

enum Gender {
  Male
  Female
  Other
}

enum StudentStatus {
  active
  inactive
  passed_out
}

enum TeacherStatus {
  active
  inactive
}

enum AttendanceSessionStatus {
  DRAFT
  NOTIFYING
  SUBMITTED
  LOCKED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}


enum CampusSession {
  MORNING
  EVENING
  FULL_DAY
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  APP
}

enum NotificationStatus {
  PENDING     // created, not processed yet
  QUEUED      // pushed to queue successfully
  SENT        // delivered successfully
  FAILED      // permanently failed after retries
}

enum BroadcastStatus{
  DRAFT
  NOTIFYING
  SUBMITTED
}

enum TargetType{
  CAMPUS
  CLASS
  SECTION
  STUDENT
  TEACHER
}

enum NotificationSourceType {
  ATTENDANCE
  BROADCAST
  HOMEWORK
  EXAM
  SYSTEM
}

enum NotificationRecipientType {
  STUDENT
  PARENT
  TEACHER
  ALL
}


model User {
  userid            String   @id
  username          String
  password          String
  isadmin           Boolean  @default(false)

  site_permissions  Json?
  page_permissions  Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model School {
  school_id      String   @id
  school_name    String
  school_type    String
  motto          String?
  school_website String?
  school_logo    String?
  extras         Json?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campuses       Campus[]
}

model Campus {
  campus_id    String   @id
  campus_name  String
  campus_type  String

  school_id    String
  school       School   @relation(fields: [school_id], references: [school_id], onDelete: Cascade)

  extras       Json?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  classes      Class[]
  students     Student[]
  teachers     Teacher[]

  @@index([school_id])
}

model Class {
  class_id           String   @id @default(uuid())

  class_name         String
  class_short_name   String?
  class_description  String?
  class_room_no      String?
  class_teacher_id   String?
  class_has_sections Boolean  @default(false)
  class_type         String?
  class_stream       String?
  class_shift        String?
  extras             Json?

  campus_id          String
  campus             Campus   @relation(fields: [campus_id], references: [campus_id], onDelete: Cascade)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  sections           Section[]

  @@index([campus_id])
}

model Section {
  section_id         String   @id @default(uuid())
  section_name       String
  section_short_name String?
  section_teacher_id String?
  section_room_no    String?
  extras             Json?

  class_id           String
  classRef           Class    @relation(fields: [class_id], references: [class_id], onDelete: Cascade)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  attendanceSessions AttendanceSession[]
  @@index([class_id])
}

model Student {
  student_id             String        @id @default(uuid())

  student_admission_no   String
  student_roll_no        String?
  student_photo_url      String?
  student_first_name     String
  student_middle_name    String?
  student_last_name      String?
  student_gender         Gender
  student_dob            DateTime
  student_current_status StudentStatus
  section_id     String
  section                Section       @relation(fields: [section_id],references: [section_id], onDelete: Cascade)

  extras                 Json?
  
  campus_id              String
  campus                 Campus        @relation(fields: [campus_id], references: [campus_id], onDelete: Cascade)

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  attendanceRecords      AttendanceRecord[]
  notifications          Notification[]
  parents                Parent[] 


  @@unique([campus_id, student_admission_no])
  @@index([campus_id])
  @@index([student_current_status])
}

model Parent {
  parent_id      String   @id @default(uuid())

  name           String
  phone          String?
  email          String?
  relation_type  String? // Father , Mother , Guardian etc

  student_id     String
  student       Student             @relation(fields: [student_id] , references : [student_id], onDelete: Cascade)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  notifications          Notification[]

  @@index([phone])
  @@unique([student_id, phone])
}

model Teacher {
  teacher_id             String        @id @default(uuid())
  teacher_employee_code  String
  teacher_first_name     String
  teacher_middle_name    String?
  teacher_last_name      String
  teacher_gender         Gender
  teacher_dob            DateTime
  teacher_photo_url      String?
  teacher_email          String        @unique
  teacher_phone          String?       @unique
  teacher_status         TeacherStatus
  extras                 Json?

  campus_id              String
  campus                 Campus        @relation(fields: [campus_id], references: [campus_id], onDelete: Cascade)

  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  attendanceSessions     AttendanceSession[]     
  updatedAttendance      AttendanceRecord[] @relation("AttendanceUpdatedBy")

  @@unique([campus_id, teacher_employee_code])
  @@index([campus_id])
}

model AttendanceSession {
  id            String   @id @default(uuid())

  sectionId     String
  teacherId     String

  date          DateTime @db.Date
  campusSession CampusSession @default(FULL_DAY)
  period        String @default("OVERALL")

  status        AttendanceSessionStatus @default(DRAFT)

  createdAt     DateTime @default(now())
  submittedAt   DateTime?
  lockedAt      DateTime?

  section       Section  @relation(fields: [sectionId], references: [section_id])
  teacher       Teacher  @relation(fields: [teacherId], references: [teacher_id])

  records       AttendanceRecord[]
  notifications Notification[]

  @@unique([sectionId, date, campusSession, period])
  @@index([sectionId, date])
  @@index([date])
}

model AttendanceRecord {
  id                  String   @id @default(uuid())

  attendanceSessionId String
  studentId           String

  status              AttendanceStatus

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  updatedBy           String?

  attendanceSession   AttendanceSession @relation(fields: [attendanceSessionId], references: [id], onDelete: Cascade)

  student             Student @relation(fields: [studentId], references: [student_id])

  updatedByTeacher Teacher? @relation("AttendanceUpdatedBy", fields: [updatedBy], references: [teacher_id])


  @@unique([attendanceSessionId, studentId])
  @@index([attendanceSessionId])
  @@index([studentId])
}

model Notification {
  id            String              @id @default(uuid())
  dedupeKey     String              @unique

  // recipient
  recipientType NotificationRecipientType
  receiverId     String?
  parentId      String? //In case of recipientType is Student ? Do i even need this ?
  senderId     String?

  channel       NotificationChannel
  payload       Json

  // source
  sourceType    NotificationSourceType
  sourceId      String  // attendanceSessionId, broadcastId, etc.

  status        NotificationStatus  @default(PENDING)
  retryCount    Int                 @default(0)
  lastError     String?
  queuedAt      DateTime?
  sentAt        DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, channel])
  @@index([sourceType, sourceId])
}


model BroadcastNotification {
  id          String   @id @default(uuid())
  title       String
  message     String
  createdBy   String   // teacher/admin
  campusId    String
  status      BroadcastStatus // DRAFT | SENT

  broadcastAttachments BroadcastAttachment[]
  broadcastTargets BroadcastTarget[]
  createdAt   DateTime @default(now())
  submittedAt   DateTime?
}

model BroadcastAttachment {
  id                     String @id @default(uuid())
  broadcastNotificationId String
  fileUrl                String
  fileName               String
  fileType               String
  fileSize               Int

  broadcastNotification  BroadcastNotification @relation(
    fields: [broadcastNotificationId],
    references: [id],
    onDelete: Cascade
  )

  @@index([broadcastNotificationId])
}

model BroadcastTarget {
  id                    String @id @default(uuid())
  broadcastNotificationId String
  targetType            TargetType // CAMPUS | CLASS | SECTION | STUDENT
  targetId              JSON?

  broadcastNotification  BroadcastNotification @relation(
    fields: [broadcastNotificationId],
    references: [id],
    onDelete: Cascade
  )

  @@index([broadcastNotificationId])
}

model UserNotification {
  id              String @id @default(uuid())
  notification_id String
  receiver_id      String
  read_at         DateTime?

  @@unique([notification_id, receiver_id]) // dedupe + idempotency
}


